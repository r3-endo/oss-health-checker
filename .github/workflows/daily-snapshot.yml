name: Daily Snapshot

on:
  schedule:
    # Daily at 09:00 JST / 00:00 UTC
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.43"
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Collect daily snapshots
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_API_BASE_URL: https://api.github.com
          GITHUB_API_TIMEOUT_MS: "5000"
          CORS_ALLOWED_ORIGINS: http://localhost:5173
        run: bun run snapshots:collect
      - name: Collect daily adoption snapshots
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GITHUB_API_BASE_URL: https://api.github.com
          GITHUB_API_TIMEOUT_MS: "5000"
          NPM_REGISTRY_API_BASE_URL: https://registry.npmjs.org
          NPM_DOWNLOADS_API_BASE_URL: https://api.npmjs.org/downloads
          NPM_REGISTRY_TIMEOUT_MS: "5000"
          ADOPTION_ENABLED_SOURCES: npm
          CORS_ALLOWED_ORIGINS: http://localhost:5173
        run: bun run adoption:snapshots:collect
